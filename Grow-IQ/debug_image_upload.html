<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .preview { margin: 20px 0; }
        .preview img { max-width: 200px; max-height: 200px; border: 1px solid #ccc; }
        .debug { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Image Upload Debug Test</h1>
    
    <div class="debug">
        <h3>Debug Info:</h3>
        <p>This page tests the image upload functionality step by step.</p>
        <p>Check the browser console for detailed logs.</p>
    </div>
    
    <form id="testForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="content">Post Content:</label>
            <textarea id="content" name="content" rows="4" placeholder="What's on your mind?" required>Test post content</textarea>
        </div>
        
        <div class="form-group">
            <label for="imageFile">Select Image:</label>
            <input type="file" id="imageFile" name="image" accept="image/*" onchange="handleFileSelect(event)">
        </div>
        
        <div class="form-group">
            <label for="postType">Post Type:</label>
            <select id="postType" name="post_type">
                <option value="general">General</option>
                <option value="job">Job</option>
                <option value="event">Event</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="isPublic">Privacy:</label>
            <select id="isPublic" name="is_public">
                <option value="true">Public</option>
                <option value="false">Connections Only</option>
            </select>
        </div>
        
        <button type="button" onclick="testFormData()">Test Form Data</button>
        <button type="button" onclick="testImageUpload()">Test Image Upload</button>
    </form>
    
    <div id="preview" class="preview" style="display: none;">
        <h3>Image Preview:</h3>
        <img id="previewImg" src="" alt="Preview">
        <p id="fileInfo"></p>
    </div>
    
    <div id="results" class="debug" style="display: none;">
        <h3>Results:</h3>
        <div id="resultContent"></div>
    </div>

    <script>
        let selectedFile = null;
        
        function handleFileSelect(event) {
            console.log('File selected:', event.target.files[0]);
            selectedFile = event.target.files[0];
            
            if (selectedFile) {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('fileInfo').textContent = 
                        `File: ${selectedFile.name}, Size: ${(selectedFile.size / 1024).toFixed(1)} KB, Type: ${selectedFile.type}`;
                    document.getElementById('preview').style.display = 'block';
                };
                reader.readAsDataURL(selectedFile);
            }
        }
        
        function testFormData() {
            console.log('=== Testing Form Data ===');
            
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            
            console.log('FormData created:', formData);
            
            // Log all form data entries
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }
            
            // Check if image is included
            const imageFile = formData.get('image');
            console.log('Image file from FormData:', imageFile);
            
            if (imageFile && imageFile.size > 0) {
                console.log('✅ Image file is properly attached to FormData');
                console.log('Image details:', {
                    name: imageFile.name,
                    size: imageFile.size,
                    type: imageFile.type
                });
            } else {
                console.log('❌ No image file found in FormData');
            }
            
            showResults('Form Data Test', {
                formDataEntries: Array.from(formData.entries()),
                hasImage: imageFile && imageFile.size > 0,
                imageDetails: imageFile ? {
                    name: imageFile.name,
                    size: imageFile.size,
                    type: imageFile.type
                } : null
            });
        }
        
        async function testImageUpload() {
            console.log('=== Testing Image Upload ===');
            
            if (!selectedFile) {
                console.log('❌ No file selected');
                showResults('Image Upload Test', { error: 'No file selected' });
                return;
            }
            
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            
            console.log('Sending FormData to server...');
            console.log('FormData contents:', formData);
            
            try {
                const response = await fetch('/social/posts/create', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Upload successful:', result);
                    showResults('Image Upload Test', { 
                        success: true, 
                        result: result,
                        status: response.status
                    });
                } else {
                    const errorText = await response.text();
                    console.log('❌ Upload failed:', response.status, errorText);
                    showResults('Image Upload Test', { 
                        success: false, 
                        error: errorText,
                        status: response.status
                    });
                }
                
            } catch (error) {
                console.error('❌ Network error:', error);
                showResults('Image Upload Test', { 
                    success: false, 
                    error: error.message,
                    networkError: true
                });
            }
        }
        
        function showResults(title, data) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultContent');
            
            contentDiv.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        // Log when page loads
        console.log('Image Upload Debug Page Loaded');
        console.log('Available functions: testFormData(), testImageUpload()');
    </script>
</body>
</html>
